### 第四章

在网络中，每一台主机和路由器中都有一个网络层部分。网络层协议是协议栈中最复杂的部分。其可分为**数据平面**和**控制平面**。

#### 网络层概述

数据平面主要是用于从输入链路向输入链路转发数据报。

控制平面主要是协调路由器转发动作，使数据包沿着源和目的地主机之间的路由器路径进行端到端传送。

##### 转发和路由选择：数据平面和控制平面

网络层的作用从表面上来看，就是**将分组从一台主机发送到一台接收主机**。因此需要以下两种功能：

- **转发**。当一个分组到达某路由器的一条输入链路时，路由器必须将分组移动到适当的输出链路，转发是数据平面中实现的**唯一功能**。
- **路由选择**。当分组从发送方流向接收方时，网络层必须决定这些分组所采用的路由或路径，算法被称为**路由选择算法**。路由选择由控制平面实现。

每台路由器都有一个**转发表**，路由器检查到达分组首部的多个字段值，根据其在转发表中索引，从而实现转发分组。

###### 控制平面：传统方法

传统路由选择算法是一台路由器的路由选择算法与其他路由器的路由选择算法通信，从而计算出转发表中的值。

###### 控制平面：SDN(software defined network 软件决定网络)算法

远程控制器计算和分发转发表以供每台路由器使用。选择功能与物理路由器是分离的，路由选择设备只执行转发，而远程控制器计算并分发转发表。

##### 网络服务模型

网络服务模型定义了分组在发送和接收端系统之间的端到端运输特性。

网络层服务**可能**包括：

- 确保交付。确保分组最终将到达目的地。
- 具有时延上界的确保交付。该服务不仅确保分组的交付，而且在时延上界内交付。
- 有序分组交付。确保分组以发送顺序到达目的地。
- 确保最小带宽。确保只要发送主机以低于某特定速率传输比特，则分组不会丢失。
- 安全性。确保运输层报文段的机密性。

因特网的网络层提供了单一的服务，称为**尽力而为服务**。不能保证一定交付，不能保证顺序接受。

#### 路由器工作原理

数据平面中，多个输入端口和输出端口与交换结构连接，路由选择控制器在控制平面中控制交换结构。

- 输入端口。输入端口在路由器中执行接入物理链路的物理层功能，还要与位于入链路远端的数据链路层交互来执行数据链路层功能，还执行查找功能。通过查询转发表决定路由器的输出端口。
- 交换结构。交换结构将路由器的输入端口连接到输入端口，完全包含在路由器之中。
- 输出端口。输出端口存储从交换结构接收的分组，并通过执行必要链路层和物理层功能在输出链路尚传输这些分组。当一条链路是双向的时，输出端口通常与该链路输入端口成对出现在同一线路卡上。
- 路由选择处理器。执行控制平面功能。传统路由器中，执行路由选择协议，维护路由选择表与关联链路状态信息，为路由器计算转发表。在SDN路由器中，其负责与远程控制器通信，接收远程控制器计算的转发表项。

控制平面需要实现的功能如下：

- 基于目的地转发。需要根据输入分组的输入端口计算最终的输出端口。
- 通用转发。除了目的地外，控制平面应该能够通过考虑分组的其他信息来决定其输出端口。

##### 输入端口处理和基于目的地转发

输入端口处理的视图普遍为：线路端接->数据链路处理(协议、拆封)->查找、转发、排队->交换结构

转发决策能在每个输入端口本地做出，无需调用集中式路由选择处理器，避免了集中式处理的瓶颈。

如果每个地址都对应一个转发表项，庞大的地址范围会导致难以存储，因此一般通过**目标地址范围**或**前缀匹配**进行转发。

一旦通过查找确定了某分组的输出端口，分组就能发送进入交换结构。在某些设计中，当其他分组正在使用交换结构，一个分组可能在进入时被阻塞，必须在输入端口排队，并等待稍后被及时调度通过交换结构。

分组的阻塞、排队与调度中还存在其他动作：

1. 物理层和链路层处理。
2. 检查分组的版本号、检验和寿命字段，并重写后两个字段。
3. 更新用于网络管理的计数器。

##### 交换

交换结构位于路由器的核心部位。并且拥有多种交换方式：

- 经内存交换。一个分组到达端口时，该端口通过中断方式向路由处理器发送信号，分组被复制到内存中，处理器提取首地址并计算输出端口，将分组复制到输出端口的缓存中。但是这样转发吞吐量低，且一次仅能处理一个内存读写。
- 经总线交换。输入端口经一根共享总线将分组直接传送到输出端口，不需要路由选择处理器的干预。让输入端口为分组预先计划一个交换机内部标签，指示本地输出端口，所有端口都能收到分组，但只有标签匹配的输出端口才能保存分组。
- 经互联网络交换。互联多个处理器形成网络，通过其中交换结构控制器来控制转发，形成纵横式交换机。纵横式交换机是**非阻塞的**。

##### 输出端口处理

将存放在输出端口内存中的分组取出并发送到输出链路上即可。

##### 何处出现排队

在输入端口和输出端口都可能形成分组队列。而无内存可用于存储到达分组时会出现**丢包**。

###### 输入排队

如果有多个队列前端分组需要发送至同一输出端口，就会出现**线路前部阻塞**，只要输入链路上分组到达速率达到其容量的58%，此时队列长度会无限增大，会出现大量丢包。

###### 输出排队

输出端口缓存堆积多个分组之后，就必须丢弃分组来腾出空间。在缓存填满前随机丢弃一个分组的策略称为**随机早期检测**。

##### 分组调度

1. 先进先出
2. 优先权排队
3. 循环和加权公平排队：分组被分为好几类，每一类都有自己的优先级，于是进行时间片轮转，每些特定时间片之中只输出一个类别，且输出顺序按照优先级排序。

#### 网际协议

主要有IPv4、IPv6。

##### IPv4数据报格式

关键字段如下：

- 版本号：规定了协议版本，路由器能够通过版本号解释IP数据报剩余部分。
- 首部长度：IPv4数据报中存在一些可变选项，因此需要4比特来确定载荷实际开始的地方。
- 服务类型：使不同类型的IP数据报(比如一些特别要求低时延、高吞吐量或可靠性的数据报)能互相区别开来。
- 数据报长度：IP数据报总长度，该字段有16比特，因此理论数据报最大长度为66535字节。
- 标识、标志、片偏移
- 寿命：寿命用于确保数据报不会永远在网络中循环，当一台路由器处理数据报时，该字段减一，当字段内容为0时，丢弃数据报。
- 协议：指明IP数据部分应该交给哪个特定运输层协议。
- 首部检验和：用于检测收到数据报中的比特错误。
- 源和目的IP地址
- 选项：选项字段允许IP首部被扩展。
- 数据

##### IPv4数据报分片

不同的链路层协议能够承载的网络层分组长度也不同，其能承载的最大数据量称作**最大传送单元**(MTU(maximum transfer unit))。

但是如果经过多条链路，可能会存在MTU比数据报长度小的问题，因此可以将数据报分成俩个较小的IP数据报，用单独的链路层帧封装，称为**片**。

片在到达目的地后需要重新组装，但是由于复杂性较大，因此将重新组装的工作放在**端系统**中，而不是路由器。

生成一个数据报时，发送主机会在其上标识标识号，被拆分的数据报中标识号相同，因此可以被认出来是被分开的数据报。但是怕中间的丢包，为了标识传输结束，在分开的最后一个数据报中的标志比特被设置为0，其他的为1.

##### IPv4编址

首先先讨论主机与路由器连入网络的方法。主机与物理链路之间的边界叫做**接口**，每个路由器都有至少两个接口，这样都能接收和发送数据报。IP要求每台主机和路由器接口都拥有自己的IP地址，因此是**一个IP地址与一个接口相关联，而不是与包括该接口的主机或路由器相关联**。

IP地址长度为32比特，使用**点分十进制记法**。即每8个比特标识一个等价数。

每台主机和路由器上的每个接口，都必须有全球唯一的IP地址，但是地址不能随意选择，其中一部分必须根据其连接的子网来决定。

分开主机和路由器的每个接口所产生的隔离的网络称为**子网**，举例来说，IP编址为子网分配一个地址233.1.1.0/24，/24称为子网掩码，说明子网地址是由左边24个比特确定的。

因特网的地址分配策略称为**无类别域间路由选择**，形式为a.b.c.d/x中的x最高比特称为地址**前缀**。剩余的32-x位是用来区分组织内部设备的。

而有一种特殊的IP地址：255.255.255.255，称为**广播地址**，当主机发出一个目的地为其的数据报时，该报文会交付给同一个网络中的所有主机。

接下来内容为**地址的分配**。

###### 获取一块地址

ISP(Internet Service Provider因特网服务提供商)会给子网分配一个地址块。比如可能分配的地址块为a.b.16.0/20，则该子网可以将地址块再细分为a.b.16.0/23、a.b.18.0/23等多个其他地址块。

###### 获取主机地址：动态主机配置协议(Dynamic Host Configure Protocal)

主机地址可以手动配置，但是一般情况都是用**动态主机配置协议(DHCP)**。DHCP允许主机自动获取一个IP地址，管理员可以通过DHCP设置来进行配置。DHCP可以**即插即用**，且是个客户-服务器协议，最简单场合下，每个子网要有一台DHCP服务器，如果没有，则需要一个DHCP中继代理，代理知道用于该网络的DHCP服务器地址。

而分配地址的流程如下：

- DHCP服务器发现。一台新到达的主机需要发现交互的DHCP服务器，可以通过**DHCP发现报文**来完成，客户在UDP分组中向广播地址，端口67发送该报文。
- DHCP服务器提供。DHCP服务器收到一个DHCP发现报文时，用**DHCP提供报文**向客户做出响应，仍然通过广播地址进行广播(实际似乎是单播？)。
- DHCP请求。新到达的客户从一个或多个服务器中选择一个，并向选中的服务器提供DHCP请求报文，回显配置的参数。
- DHCP ACK。服务器用ACK报文对请求报文进行响应，证实所要求参数。

##### 网络地址转换(Network address translator)

管理IP地址的典型方法就是**网络地址转换**(NAT)。

许多家庭网络都是用10.0.0.0/24当作专用地址，但是他们在全球因特网中显然不能使用，为了处理他们的编址问题，需要使用NAT。

NAT对外界隐藏了家庭网络的所有细节，使进入家庭网络的报文都同一个目的IP地址。且因特网留有一定范围用于NAT，不会被公共网络分配。

而为了知道分组是要转发给哪个内部主机，需要使用**NAT转换表**，在表项中包含端口号和IP地址。

在内网设备向外网发射请求时，NAT转换表记录私网地址到公网地址的映射。回应报文通过此映射来回传。

##### IPv6

###### 数据报格式变化

- 扩大的地址容量：地址长度增加到128比特，引入了**任播地址**，这种地址可以使数据报交付给一组主机的任意一个。
- 简化高效的40字节首部。
- 流标签。可以给特殊流的分组加上标签，提高流量优先级。

###### 4和6对比

- 分片/重新组装：IPv6不允许分片和重新组装，因此如果数据报太大会被直接丢弃，并返回“分组太大”的ICMP差错报文。
- 首部检验和。IPv6中去除了。因为运输层和数据链路层也有检验操作。
- 选项：选项不再是IP首部的必需品。

#### 通用转发和SDN

由于大量的路由器拥有不同的硬件、软件和管理界面，因此有了**软件定义网络**(SDN)。统一提供网络层以及链路层功能，并将转发设备描述为分组交换机，为每台交换机增加一张匹配加动作表。

通过计算流表，将其发给设备中的控制代理，控制代理把流表装载在分组交换机，基于流表做出相应的动作。
