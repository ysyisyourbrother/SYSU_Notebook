### 回顾：Web页面请求的历程

<img src="C:\Users\hp\Documents\WeChat Files\wxid_j96pgjli7gpn12\FileStorage\Temp\6fd3891e11fa99841d0d1ea302bab4d.jpg" alt="6fd3891e11fa99841d0d1ea302bab4d" style="zoom:50%;" />

##### 准备：DHCP、UDP、IP和以太网

使用以太网电缆将电脑与以太网交换机连接起来、交换机又与路由器连接。

路由器与ISP连接，为学校提供DNS服务，且DNS服务器不在学校网络中。

电脑刚与交换机连接时，没有IP地址不能做任何事情，因此交换机采取的相关动作是**运行DHCP协议**，通过其获取IP地址和其他信息。

###### DHCP协议工作过程

1. 电脑操作系统生成一个**DHCP请求报文**，将其放入具有目的端口67(DHCP服务器)和源端口68(DHCP客户)的**UDP报文段**。该UDP报文段放在一个目的地址为**广播地址**，源地址为**0.0.0.0**的**IP数据报**中。
2. 包含DHCP请求的报文的IP数据报被放置在**以太网帧**中，以太网帧的目的MAC地址也是**广播地址**，源MAC地址为电脑的接口MAC地址。
3. 包含DHCP请求的广播以太网帧由于是第一个从电脑到交换机的帧，因此每一层交换机中都采用广播的形式发送。
4. 路由器在其接口接收到广播以太网帧，该帧中包含DHCP请求，因此从帧中抽出IP数据报，该数据报的广播IP目的地指示IP数据报应该由节点的高层协议处理，因此数据报的载荷**被分解**向上到达UDP，DHCP请求报文从UDP报文段中抽取出来，DHCP服务器得到DHCP请求报文。
5. 假设路由器中的DHCP服务器能够以**CIDR**块68.85.2.0/24分配IP地址，并且DHCP服务器分配68.85.2.101给电脑，DHCP服务器生成包含这个IP地址以及DNS服务器地址的IP地址、默认网关路由器的IP地址和子网块(网络掩码)的一个**DHCP ACK报文段**。该报文被放入一个UDP报文段中，UDP报文段被放入IP数据报中，IP数据报被放入以太网帧中。以太网帧源地址是路由器接口MAC地址，目的MAC地址是电脑的MAC地址。
6. 以太网帧被发给交换机，因为交换机**自学习**的性质，因此帧成功转发。
7. 电脑收到以太网帧后，从以太网帧中抽取IP数据报、再从中抽取UDP报文段、再抽取出DHCP ACK报文。电脑的DHCP客户记录下它的IP地址和它DNS服务器的IP地址，且在其**IP转发表**中安装默认网关的地址，之后电脑将对网关发送目的地址为子网以外的所有数据报。

##### 仍在准备：DNS和ARP

电脑键入www.google.com到Web服务器，开启了一长串事件。

Web浏览器通过生成一个**TCP套接字**开始了该过程，套接字向网站发送**HTTP请求**。为了生成套接字，电脑需要知道www.google.com的IP地址，因此要用到**DNS协议**。

8. 电脑操作系统生成一个**DNS查询报文**，把网站地址放在DNS报文的问题段中，报文放置在一个由53号端口(DNS服务器)目的端口的UDP报文段。UDP报文段放入目的IP地址为步骤5中返回的DNS服务器地址和源IP地址为68.85.2.101的IP数据报中。
9. 电脑将包含DNS请求报文的数据报放入一个以太网帧中，该帧先发送到网关路由器，但是电脑只从DHCP ACK报文获得了网关的IP地址，不知道MAC地址，因此需要使用**ARP协议**。
10. 电脑生成一个具有默认网关地址为目的IP地址的**ARP查询报文**，将报文放在目的地址为广播地址的以太网帧中，并向交换机发送，这样就可以广播给所有连接的设备。
11. 网关路由器收到ARP查询报文的帧，发现在ARP报文中目标IP地址匹配其接口的IP地址，因此准备一个**ARP回答**，指示其对应IP地址的MAC地址。将ARP回答放在以太网帧中，目的地址为主机MAC地址，向交换机发送该帧，交换机发送给电脑。
12. 电脑收到ARP回答报文的帧，抽取网关路由器的MAC地址。
13. 主机将包含DNS查询的以太网帧寻址到网关路由器的MAC地址，向交换机发送该帧，交换机发送给网关。

##### 仍在准备：域内路由选择到DNS服务器

14. 网关路由器接受该帧并抽取包含DNS查询的IP数据报，路由器查找数据报的目的地址，并根据转发表决定应当发送到哪个路由器。IP数据报放置在链路层帧中。
15. 合适的路由器接收到该帧，抽取IP数据报，检查数据包的目的地址，根据转发表确定出接口，经过该接口朝着DNS服务器转发数据报。转发表是根据**因特网域间协议BGP**所填写的。
16. 最终包含DNS查询的IP数据报到达了DNS服务器，抽取出DNS查询报文，在数据库中找到对应的IP地址的**DNS源记录**。这种缓存数据源于google.com的**权威DNS服务器**。DNS服务器形成了一个包含主机名到IP地址映射的**DNS回答报文**，将该DNS回答报文放入UDP报文段中，报文段再放入寻址到电脑的IP数据报中，随后转发发送。
17. 电脑最终收到IP地址，准备接触www.google.com服务器。

##### Web客户-服务器交互：TCP和HTTP

18. 当电脑有了www.google.com的IP地址后，可以生成**TCP套接字**，该套接字向网站发送**HTTP GET报文**，当主机生成TCP套接字后，先与网站中TCP执行**三次握手**，首先电脑生成一个目的端口为80(针对HTTP)的**TCP SYN报文段**，放在具有目的地址为该网站IP的IP数据报中，数据报放在MAC地址为网关路由器MAC地址的帧中，并向交换机发送该帧。
19. 谷歌收到TCP SYN数据报，发送**TCP SYNACK**报文段，放入向电脑寻址的一个数据报中，放入链路层帧中，该链路适合将谷歌网站连接到其第一跳路由器。
20. TCP SYNACK报文段到达电脑的以太网卡后，进入连接状态。
21. 借助电脑上的套接字，电脑浏览器生成的获取URL的HTTP GET报文ieru套接字，GET报文生成一个TCP报文段载荷，放到数据报中并交付。
22. 谷歌的HTTP服务器接收到TCP套接字中的HTTP GET报文，生成一个**HTTP响应**报文，将请求的Web页面内容放入HTTP响应体中，发送金TCP套接字中。
23. Web网页的html传入电脑，显示Web网页。