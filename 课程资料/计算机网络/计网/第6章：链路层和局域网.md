### 第六章

链路层与局域网

#### 链路层概述

运行链路层协议的任何设备都称作**节点**，沿着通信路径连接相邻节点的通信信道称为**链路**。在同个特定链路时，传输节点将数据报封装在**链路层帧**中，并将该帧传送到链路中。

##### 链路层提供的服务

- 成帧。数据报传输之前，都须用链路层帧封装，帧的结构由链路层协议规定。
- 链路接入。**媒体访问控制**(MAC-medium access control)协议规定了帧在链路上传输的规则。
- 可靠交付。当链路层协议提供可靠交付服务时，他保证无差错经链路层移动每个网络层数据报。
- 差错检测和纠正。

##### 链路层在何处实现

链路层的主体部分在**网络适配器**中实现，也称作**网络接口卡**。

#### 差错检测和纠错技术

在发送节点，为了保护信息，使用**差错检测和纠正比特**(EDC)来增强数据D，数据报发送D+EDC，传输过后接收方收到D'+EDC'。

##### 奇偶校验

采用单个**奇偶校验位**，接收方操作简单，只需比对前d位1的个数即可，但是可能检测不出差错。

也可以使用**二维奇偶检验**，每行每列都给出奇偶校验位，逐个进行比对。

##### 检验和方法

把数据分割成多个k比特的序列，这些序列内部相加后得到的新序列取反码就是检验和，由于反码和原码相加全为1，因此收到后全部加起来即可判断是否出错。

##### 循环冗余检测

步骤如下：

1. 发送方和接收方协商实现一个r+1的比特模式G，叫做**生成多项式**。
2. 对于给定的数据段D，发送方选择r个附加比特R，附加在D后面。
3. 得到的d+r比特模式用模二算数(异或)恰好能被G整除。

#### 多路访问链路和协议

网络链路有两个类型：点对点链路和广播链路。

点对点链路由链路一段单个发送方和另一端单个接收端组成。

广播链路则是让多个发送和接收节点都连接到相同的、单一的、共享的广播信道上。而如何协调多个发送和接收节点在同一信道的访问，就是**多路访问问题**。

当接收方收到多个节点时，传输的帧会在接收方处发生**碰撞**，碰撞帧信号纠缠在一起，因此涉及碰撞的所有帧都丢失了。

因此需要以下**多路访问协议**来解决此问题：

##### 信道划分协议

###### 时分多路复用(TDM)

假设一个支持N个节点的信道且信道的传输速率位Rbps，TDM将时间划分为**时间帧**，再进一步把每个时间帧划分为N个**时隙**，然后把时隙分给N个节点中的其中一个，这样无论何时某个节点需要传输分组时，它都可以在循环的TDM帧中指派给他的时隙内传输比特。

###### 频分多路复用(FDM)

将信道分为多个频段，再单个较大Rbps信道创建了N个较小的R/Nbps信道。

###### 码分多址(CDMA-code division multiple access)

TDM和FDM同时划分时隙和频率，CDMA对不同节点分配不同的编码。然后每个节点用唯一的编码来对发送的数据进行编码，因此不同的节点可以同时传输并保持正确性。

##### 随机接入协议

一个传输节点总是以信道的全部速率进行发送，当有碰撞时，涉及碰撞的每个节点重复重发它的帧，直到无碰撞为止。但是当一个节点经历碰撞时，不会立刻重发，而是等待一个**随机时延**。

###### 时隙ALOHA

时间被划分为L/R秒的时隙，当有碰撞时，节点有概率p在后续的每个节点重传，直到被无碰撞地传出去。

时隙ALOHA在只有一个活跃节点时效率出色，但是当节点躲起来后，一部分时隙有碰撞就会被浪费。

###### ALOHA

ALOHA协议是一个非时隙、完全分散的协议。当一帧首次到达，节点立刻将该帧传输进广播信道，当遇到碰撞时，这个节点立刻以p的概率重传，否则需要**等待一个节点传输时间**。

###### 载波侦听多路访问(CSMA-carrier sense multiple access)

ALOHA中并不关心广播信道上其他节点的活动。

因此载波侦听多路访问有以下规则：

- 载波侦听。一个节点在传输前先听信道，如果有另一个节点的帧在信道上发送，节点等待直到检测到一小段时间没有传输，然后再开始传输。
- 碰撞检测。一个节点在传输时也在持续侦听信道，如果有另一个节点也开始传输，则停止传输，等待一段随机时间后再开始传输。

##### 轮流协议

前面提到的协议都没有满足：**当有M个节点活跃时，每个活跃节点的吞吐量接近R/M bps**，因此轮流协议解决了这一问题。

使用**轮询协议**，要求一个节点作为主节点，主节点以循环的方式轮询每个节点，主节点向轮询的节点发送报文，告诉它能够传输的帧的最多数量。

轮询消除了碰撞和空时隙，但是会有**轮询时延**。而且如果主节点出现了故障，整个信道都会变得不可操作。

##### DOCSIS：用于电缆因特网接入的链路层协议

一个电缆接入网经常在电缆网头端将几千个住宅电调制解调器与一个**电缆调制解调器端接系统**连接。DOCSIS使用FDM将网络段分为多个频率信道，每个信道大约有40Mbps的吞吐量。

#### 交换局域网

交换机运行在链路层，因此交换链路层帧时不识别网络层地址而是使用链路层地址。

##### 链路层寻址和ARP

###### MAC地址

主机并没有链路层地址，而是它的适配器(网络接口)有链路层地址。对于大多数局域网而言，MAC地址长度为6字节，有$2^{48}$个可能的MAC地址，全世界不存在MAC地址相同的适配器。

当某适配器要向目的适配器发送一帧时，发送适配器将目的适配器的MAC地址插入该帧，并将该帧发送到局域网上。接收器接收时，也检查MAC地址与自己的MAC地址是否匹配，如果匹配就提取帧中封装的数据，不匹配就丢弃。

MAC地址也有广播地址，为FF-FF-FF-FF-FF-FF。

###### 地址解析协议(ARP-address resolution protocol)

因为存在网络层地址(ip地址)和链路层地址(MAC)地址，所以需要进行转换，这是地址解析协议的任务。

发送主机中的ARP模块取**相同局域网**任何IP地址作为输入，返回相应的MAC地址。

每台主机和路由器内存中都有一个**ARP表**，包含了IP地址到MAC地址的映射关系，且其中包含TTL，标识从表中删除每个映射的时间。

但是如果ARP表中没有目的主机的表项时，发送方需要用ARP协议来解析这个地址，先构造一个**ARP分组**，一个ARP分组包含发送和接收IP地址以及MAC地址，使用此分组向其他路由器询问目的地址的MAC地址。

###### 发送数据到子网以外

当子网1的主机要发送数据到子网2的数据上，适配器应该先使用路由器接口的MAC地址，将信息传输到路由器，包含一个寻址到子网2的数据报，打包成一个帧，传递给路由器的网络层。网络层再指示应该如何到达目的主机。

##### 以太网

###### 以太网帧结构

以太网帧主要分为以下6个字段：

- 数据字段。这个字段承载了IP数据报。
- 目的地址。
- 源地址。
- 类型字段。类型字段允许以太网服用多种网络层协议，不仅仅是IP。
- CRC。循环冗余检测，用于检测帧中是否引入了差错。
- 前同步码。前同步码负责唤醒接受适配器，使其与发送方时钟同步。

##### 链路层交换机

交换机的任务使接收入链路层帧并将它们转发到出链路。

交换机自身对子网中的主机和路由器使**透明的**。某主机向另一个主机寻址一个帧，将其送入局域网，并不知道交换机会接收该帧并转发到另一个节点。

###### 交换机转发和过滤

**过滤**是决定一个帧该转发到某个接口还是直接丢弃的交换机功能。

**转发**是决定一个帧应该被导向哪个接口，并把帧移动到那些接口的交换机功能。

交换机的转发和过滤都通过**交换机表**完成。而交换机表中包含：

1. 一个MAC地址。
2. 通向该MAC地址的交换机接口。
3. 表项放置在表中的时间。

当目的地址为D的帧从交换机接口x到达，交换机用MAC地址D索引它的表，有以下情况：

- 表中没有对于D的表项，交换机向除接口x外所有接口前面的输出缓存转发该帧的副本，即广播。
- 表中有表项把D与接口x连接起来(即输出=输入)，直接丢弃该帧。
- 有表项将接口y与其联系，则转发到y。

###### 自学习

交换机的表是自动、动态和自治地建立地，不需要任何干预。

这种能力是通过以下方式实现：

1. 交换机表初始为空。
2. 对于每个接口接收到的每个入帧，存储源地址地MAC地址、该帧到达的接口、当前时间。
3. 如果在一段时间后，交换机没有收到以该地址作为源地址的帧，则在表中删除这段地址。

交换机是**即插即用设备**。

###### 链路层交换机的性质

基于链路层交换机的基本特点，其有以下优点：

- 消除碰撞。在使用交换机构建的局域网中，没有因碰撞而产生的带宽浪费。因为交换机不会同时在网段上传输多于一个帧。
- 异质的链路。交换机将链路彼此隔离，因此不同链路能以不同速度在不同媒体上运行。
- 管理。方便进行网络管理。

###### 交换机与路由器比较

路由器是使用网络层地址转发分组的存储转发分组交换机。而交换机使用MAC地址转发分组。

交换机是第二层的分组交换机，路由器是第三层的分组交换机。

交换机即插即用，且速度很快，但是路由器没有生成树限制，且可以寻找最佳路径，而且有防火墙防护。

##### 虚拟局域网(VLAN)

支持VLAN的交换机允许经一个单一的物理局域网基础设施定义多个虚拟局域网。在一个VLAN内的主机彼此通悉，仿佛他们与交换机连接。

交换机的端口由网络管理员划分为组。

且当需要两个虚拟局域网交流时，一种常见方法是在每台交换机定义一个属于对方虚拟局域网的端口，将此互连起来。

#### 链路虚拟化：网络作为链路层

**多协议标签交换**(MPLS)是一种分组交换的虚电路网络，其关键概念在于：固定长度标签。

其可以通过链路层和IP两层进行传播，稳定且扩展性高，网络资源很容易共享。





