### 第五章

控制平面是一种网络范围的逻辑，控制着源主机到目的主机端到端路径间路由器如何转发数据报，也控制网络层组件和服务如何配置和管理。

#### 路由选择算法

路由选择算法的目的是从发送方到接收方确定一条通过路由器网络的好的路径。

一般使用图来解决路由选择问题。将端到端开销抽象成点对点之间的路径长度，因此找到最低开销路径即可。

一般而言，路由选择算法的分类方式是根据集中式还是分散式来划分：

- 集中式路由选择算法：用**全局性**的网络知识计算路径，需要在算法开始前就得知所需的所有信息。全局算法的典型例子之一就是**链路状态算法**(LS-Link state)。
- 分散式路由选择算法：通过迭代计算和相邻节点信息交换，一个节点可以逐步计算出到达某个节点的最低开销路径。**距离向量(DV-Distance Vector)路由选择算法**是其中之一。

##### 链路状态路由选择算法

直接使用Dijkstra算法进行计算。但是LS算法运行时，多个节点同时运算可能导致最优路径反复变化，导致**流量振荡**，因此需要避免多个节点同时运行LS算法。

##### 距离向量路由选择算法

距离向量算法是一种迭代的、异步的和分布式的算法。因为每个节点需要从邻居接收信息进行计算，并将结果分发给邻居，且此过程要持续到无需交换更多信息为止，而且不要求同步操作。

令$d_x(y)$为节点x到y的最低开销路径，其公式为$d_x(y)=\min_v\{c(x,v)+d_v(y)\}$

方程中的$\min_v$是**x的所有邻居**。

###### 链路开销改变与链路故障

当节点检测到邻居的链路开销发生变化时，他会更新其距离向量，如果最低路径发生变化，它则会通知邻居更新其距离向量，随后再接收邻居的更新进行更改。

且可能出现y节点选择z，z节点选择y的循环情况，这样会形成**路由选择环路**。

###### 增加毒性逆转

解决路由选择环路可以通过毒性逆转加以避免。

其思路为：如果z通过y路由选择目的地x，则z将告诉y，z到x的路径为**无穷大**，这样y就不会也选择经路由z到x了。

#### 因特网中自治系统内部路由选择：OSPF(Open Shortest Path First)

如果整个互联网都是用同样的路由选择算法可能会不够效率，因为每种路由选择算法在特定场景下都有自己的优势，因此可以通过路由器组织进**自治系统**(AS)来解决效率问题。

在相同AS中的路由器运行相同的路由器算法并有彼此的信息，同一个自治系统内运行的路由选择算法为**自治系统内部路由选择协议**。

##### 开放最短路优先(OSPF)

OSPF是一种链路状态协议，它使用洪泛链路状态信息和Dijkstra最低开销路径算法。使用OSPF，一台路由器就会构建一整个自治系统的完整拓扑图，因此每台路由器都可以本地运行算法。

使用OSPF时，路由器向自治系统内所有其他路由器广播路由选择信息，且当链路状态发生变化时，也会广播。

其优点如下：

- 安全。能够鉴别OSPF路由器之间的交换。仅有受信任的路由器才能参与AS内的OSPF协议，因此可以防止不正确的信息被注入到路由器表内。
- 多条相同开销的路径。当多条路径到达目的地有相同的开销时，OSPF允许使用多条路径以分散流量。
- 对单播与多播路由选择的综合支持。
- 支持在单个AS中的层次结构。一个OSPF自治系统能够层次化地配置多个区域，每个区域运行自己的选择算法，随后通过边界路由器提供路由选择。

#### ISP之间的路由选择：BGP

当分组跨多个AS来进行路由时，我们需要**自治系统间路由协议**(ISP)来进行多个AS之间的协调。AS间必须执行相同的AS间路由选择协议，称为**边界网关协议**(BGP-Boader Gateway Protocal)。

##### BGP的作用

BGP中，控制着分组从路由到达其他的子网，因此BGP为每台路由提供了以下手段：

- 从邻居AS获得前缀的可达性信息。BGP允许每个子网向因特网其他部分通告他的存在，确保所有AS知道该子网。
- 确定到该前缀的“最好的路由”。可能有多个路径可以到达子网，因此路由器将本地运行BGP路由选择过程，得到最好路径。

##### 通告BGP路由信息

对于每台AS，**网关路由器**就是位于AS边缘的路由器，而**内部路由器**就是仅连接AS内部主机的路由器。

BGP中，每对路由器通过使用179端口的半永久TCP连接交换路由选择信息。每条直接连接以及所有通过该连接发送的BGP报文，称为BGP连接。跨越两个AS的连接称为外部BGP，同一AS内的为内部BGP。

AS内部通过内部BGP传播，跨AS路由信息通过外部BGP传播。

##### 确定最好路由

当路由器通过BGP连接通告前缀时，它在前缀中包括一些**BGP属性**，前缀机器属性称为**路由**。两个较为重要的属性分别是：AS-PATH和NEXT-HOP。AS-PATH属性包含了已经通过的AS列表，BGP路由器使用其来检测和避免环路。(当自己的AS号已经出现在AS-PATH时，它将拒绝通告)

NEXT-HOP是AS-PATH起始的路由器接口的IP地址。

###### 热土豆路由选择

**选择的路由到开始该路由的NEXT-HOP路由器具有最小开销**，其原理为：**对每个AS，都尽快将分组送出自己的范围，而不担心AS外部到目的地余下部分的开销**。因此是自私的算法。

###### 路由器选择算法

路由被指派一个**本地偏好**作为属性之一。一条路由的本地偏好可能由该路由器设置或者从AS内另一台路由器学习到，是由管理员决定的策略。

从余下的路由中选择具有最短AS-PATH的路由，随后再从余下的路由使用热土豆路由选择。如果仍剩下很多路由，则使用BGP标识符来选择路由。

##### IP任播

BGP常用于实现IP任播服务。整个因特网中可能存在多个服务器拥有同一IP内容的复制，因此BGP可以将用户指向有改内容最近的服务器。

IP任播被广泛用于DNS系统请求指向最近的根DNS服务器。

#### SDN控制平面

SDN体系结构具有4个关键特征：

- 基于流的转发。SDN控制平面的工作是计算、管理和安装所有网络交换机中的流表项。
- 数据平面与控制平面分离。
- 网络控制功能：位于数据平面交换机外部。保证提供协调的、可扩展的性能和高可用性。
- 可编程的网络。可以通过SDN控制器提供的API来对数据平面进行定义和控制。

##### SDN控制器和SDN网络控制应用程序

SDN控制平面主要分为两个部分：SDN控制器和SDN网络控制应用程序。

SDN控制器自底向上可以分为三个层次：

- 通信层。SDN控制器和受控网络设备之间的通信。用于设备向控制器传递本地观察到的时间(比如某个设备加入了网络)，让SDN控制器拥有网络状态的最新视图。
- 网络范围状态管理层。SDN控制平面做出的控制决定，要求控制器具有控制设备的最新状态信息，此层就负责掌握和维护这些表的信息。
- 对于网络控制应用程序层的接口。负责与网络控制应用程序交互，提供各种类型API。

SDN控制器被认为是“逻辑上集中的”，但是出于高性能和故障容忍等方面，这些服务和状态信息保持一般使用分布式服务器保存和实现。

##### OpenFLow协议

OpenFlow协议运行在SDN控制器和SDN控制的交换机设备之间，此协议运行在TCP之上，使用6653的默认端口号。

从控制器到受控交换机流动的重要报文如下：

- 配置。查询并设置交换机的配置参数。
- 修改状态。修改表项，兵设置交换机端口特性。
- 读状态。从流表和端口收集数据。
- 发送分组。用于在受控交换机从特定端口发出一个特定的报文。
- 流删除。通知控制器已删除一个流表项。
- 端口状态。

#### ICMP：因特网控制报文协议(Internet Control Message Protocol)

ICMP被主机和路由器用来彼此沟通网络层的信息，最典型的用途为差错报告。

Tracert程序就是通过ICMP报文实现的，源主机中tracert向目的地主机发送一系列普通的IP数据报，这些数据报都携带了一个具有不可达UDP端口号的UDP报文段，第一个TTL为1，第二个为2，以此类推。当第n个数据报到达第n台路由器时，第n台路由器观察到TTL正好过期，因此路由器**丢弃数据报**并发送一个**ICMP警告报文给源主机**，包含路由器的名字和其IP地址，因此可以得到途径的第n台路由器信息。且可以从定时器中得知往返时延。

#### 网络管理和SNMP(Simple Network Message Protocol)

网络管理包括了硬件、软件和人类元素的设置、综合和协调，以监视、测试、轮询、配置、分析、评价和控制网络及网元资源，用合理的成本满足实时性、运营性能和服务质量的要求。

##### 网络管理框架

- 管理服务器。执行网络管理活动的地方，从这里发起控制网络行为的动作。
- 被管设备。
- 管理信息库(MIB)。用于存储每个被管对象的信息。
- 网络管理代理。是运行在被管对象中的一个进程，负责与管理服务器通信，在管理服务器的命令和控制下在被管设备中采取本地动作。
- 网络管理协议。允许管理服务器查询被管设备的状态，并经过其代理间接地在设备上采取行动。
